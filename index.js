// Copyright (c) 2025 Ali Eslamdoust
// MIT License

require("dotenv").config();const{Telegraf:Telegraf}=require("telegraf"),fs=require("fs"),path=require("path"),{v4:uuidv4}=require("uuid"),log=require("./log"),db=require("./db"),authorization=require("./authorization"),pq=require("./cb_p"),axios=require("axios"),mime=require("mime-types");let localVariable=new Object;const bot_token=process.env.BOT_TOKEN,bot=new Telegraf(bot_token);bot.use((async(e,a)=>{const t=e.from.id;localVariable[t]=localVariable[t]?localVariable[t]:new Object;const s=await db.userExists(t);s?a():s||t!=process.env.OWNER||(await db.addUser(t,"owner"),a())})),bot.start((async e=>{const a=e.from.id,t=await db.getUser(a);if(!t.ok)return;const s=await pq.process_queries(t.data,"start",e);sendMessage(s.receiversId,s.messageText,s.inlineKeyboard),localVariable[a].receiver=""})),bot.on("callback_query",(async e=>{const a=e.from.id,t=await db.getUser(a);if(!t.ok)return;const s=e.update.callback_query.data,r=e.msgId;let i;if("start_again"===s)bot.telegram.deleteMessage(a,r),i=await pq.process_queries(t.data,"start",e),sendMessage(a,i.messageText,i.inlineKeyboard);else if(s.includes("watermarkPosition")||s.includes("confirmPost")){const o=path.join(__dirname,`./media/${s.split("_")[1]}.json`);let n=JSON.parse(await fs.promises.readFile(o)),d=s.split("_")[0];if(i=await pq.process_queries(t.data,d,e,n),!i.media.mediaType)return bot.telegram.deleteMessage(a,r),void sendMessage(a,"❌ این پست به دلیل گذشتن از زمان مجاز از سرور حذف شده است. لطفا مجددا اقدام کنید",[[{text:"🔙 بازگشت",callback_data:"start"}]]);i.media.mediaType&&!i.media.confirm&&sendMessage(a,i.messageText,i.inlineKeyboard),sendMessage(i.receiversId,i.messageText,i.inlineKeyboard,void 0,!1,!0,i.media)}else i=await pq.process_queries(t.data,s,e),sendMessage(i.receiversId,i.messageText,i.inlineKeyboard,r,!0);localVariable[a].receiver=i.receiver})),bot.command("help",(e=>{e.reply('❕راهنما:\n\n🔸شخصی سازی امضای پیام ها و واترمارک از قسمت "⚙️ تنظیمات ربات"  امکان پذیر است\n🔹کارکرد درست ربات منوط به کانفیگ کردن درست فایل .env در کد های ربات می باشد. (نمونه کانفیگّ در .env.example قرار داده شده)\n🔸جهت دریافت آیدی عددی کانال خود دستور /getnumericid را ارسال کرده و یک پیام از کانال مورد نظر فوروارد کنید')})),bot.command("creator",(e=>{e.reply("Created by Ali Eslamdoust\n@E3410\nGithub: https://github.com/alieslamdoust\nInstagram: https://instagram.com/ali_eslamdoust")}));let waitingForForward=!1;async function sendMessage(e,a,t,s,r,i,o){try{if(a=(a=a||"").replace(/[-()\.=-_\[\]\{\}\<\>\#\+\|]/g,"\\$&"),r&&!i)await bot.telegram.editMessageText(e,s,void 0,a,{reply_markup:{inline_keyboard:t},parse_mode:"MarkdownV2"});else if(r||i){if(!r&&i)if("image"===o.mediaType){const s=await bot.telegram.sendPhoto(e,{source:o.filePath},{caption:a,reply_markup:{inline_keyboard:t},parse_mode:"MarkdownV2"});if(o.confirm){const a=String(e).replace("-100",""),t=`https://t.me/c/${a}/${s.message_id}`;await db.updatePostStats(o.postId,t),await bot.telegram.sendMessage(o.message.chatId,o.message.text+`:\n${t}`,{reply_markup:{inline_keyboard:o.message.keyboard},parse_mode:"MarkdownV2"})}}else if("video"===o.mediaType){const s=await bot.telegram.sendVideo(e,{source:o.filePath},{caption:a,reply_markup:{inline_keyboard:t},parse_mode:"MarkdownV2"});if(o.confirm){const a=String(e).replace("-100",""),t=`https://t.me/c/${a}/${s.message_id}`;await db.updatePostStats(o.postId,t),await bot.telegram.sendMessage(o.message.chatId,o.message.text+`:\n${t}`,{reply_markup:{inline_keyboard:o.message.keyborad},parse_mode:"MarkdownV2"})}}}else await bot.telegram.sendMessage(e,a,{reply_markup:{inline_keyboard:t},parse_mode:"MarkdownV2"})}catch(e){log.log_handler("Error while sending a message: "+e,"ERROR")}}async function signMessages(e,a){let t,s=!0;try{e=e||"";const r=await db.getConfig("isSign");if(!r.ok)throw new Error;if(!(1===r.data.value||"1"===r.data.value))return{ok:s,data:e};const i=await db.getConfig("writerSign");if(!i.ok)throw new Error;let o=1===i.data.value||"1"===i.data.value,n="";if(o){const e=await db.getUser(a);if(!e.ok)throw new Error;n=`\n\n🖋 ${e.data.name}\n`}else n="\n\n";const d=await db.getConfig("signature");if(!d.ok)throw new Error;n+=d.data.value,t=e+n}catch(e){log.log_handler("Error while signing messages: "+e,"ERROR"),s=!1}finally{return{ok:s,data:t}}}function setTimer(e){try{setTimeout((()=>{fs.unlink(e,(e=>{if(e)throw new Error}))}),6e5)}catch(a){setTimer(e),log.log_handler("Error while deleting files: "+a,"ERROR")}}bot.command("getnumericid",(e=>{e.reply("لطفا یک پیام از کانال/گروهی که آیدی عددی آن را میخواهید به اینجا فوروارد کنید:"),waitingForForward=!0})),bot.on("message",(async e=>{if(waitingForForward){if(waitingForForward=!1,!e.message.forward_from_chat)return void e.reply("پیام باید از کانال مورد نظر فوروارد شده باشد.");const a=e.message.forward_from_chat.id;return void e.reply(`آیدی عددی کانال/گروه مورد نظر: \`${a}\``)}const a=e.from.id;let t,s,r=!0,i=e.message.text;try{switch(localVariable[a].receiver){case"getNewUserId":if(s=[[{text:"🔙 بازگشت",callback_data:"manageUsers"}]],isNaN(i))return r=!1,t="❌ آیدی عددی باید تنها متشکل از اعداد باشد. لطفا آیدی صحیح را مجددا وارد کنید\n\n❗️ دقت کنید که عدد باید به انگلیسی وارد شود",void sendMessage(a,t,s);if(!await db.addUser(i))return t="❌ مشکلی پیش آمده است. لطفا آیدی عددی را دوباره وارد کنید",void sendMessage(a,t,s);t="✅ کاربر جدید با موفقیت اضافه شد\n\n❔ جهت تغییر سطح دسترسی کاربر میتوانید با مراجعه به پروفایل ایشان، دسترسی را تغییر دهید",sendMessage(a,t,s);break;case"findUserWithId":if(isNaN(i)){t="❌ آیدی عددی وارد شده اشتباه میباشد",s=[[{text:"🔙 بازگشت",callback_data:"seeUsers"}]];break}if(!await db.userExists(i)){t='❌ کاربر مورد نظر در ربات عضو نمی باشد\nلطفا جهت اضافه کردن کاربر به ربات از بخش "👥 مدیریت کاربران > ➕ افزودن کاربر جدید" اقدام کنید',s=[[{text:"🔙 بازگشت",callback_data:"seeUsers"}]];break}const o=await db.getUser(a);if(!o.ok)break;const n=await pq.process_queries({id:a,role:o.data.role},`seeUser/${i}`,e);sendMessage(n.receiversId,n.messageText,n.inlineKeyboard);break;case"newSign":if(s=[[{text:"🔙 بازگشت",callback_data:"settings"}]],"string"!=typeof i)return t="❌ ورودی اشتباه است. یک متن کوتاه برای امضای پیام ها وارد کنید:",void sendMessage(a,t,s);if(!await db.updateConfig("signature",i))return t="❌ مشکلی پیش آمد. لطفا دوباره تلاش کنید",void sendMessage(a,t,s);t="✅ امضای جدید با موفقیت تنظیم شد",sendMessage(a,t,s);break;case"changeName":if(s=[[{text:"🔙 بازگشت",callback_data:"profile"}]],"string"!=typeof i||i.length<3||i.length>32)return t="❌ ورودی باید کلمه ای به طول 3 تا 32 حرف باشد",void sendMessage(a,t,s);if(!await db.updateUsersName(i,a))return t="❌ مشکلی پیش آمد. لطفا دوباره تلاش کنید",void sendMessage(a,t,s);t="✅ نام جدید با موفقیت تنظیم شد",sendMessage(a,t,s);break;case"watermark":try{const a=await e.telegram.getFileLink(e.message.document.file_id),s=await axios.get(a,{responseType:"arraybuffer"}),r=Buffer.from(s.data);if("image/png"===mime.lookup(e.message.document.file_name)){const e="./media/watermark.png",a=path.join(__dirname,e);await fs.promises.writeFile(a,r),log.log_handler(`new watermark PNG file saved: ${e}`,"INFO"),t="✅ واترمارک جدید با موفقیت تنظیم شد"}else t="❗️ مشکلی در تجزیه تصویر پیش آمد. لطفا مجددا امتحان کنید"}catch(e){log.log_handler("Error processing media: "+e,"ERROR"),t="❗️ مشکلی در تجزیه تصویر پیش آمد. لطفا مجددا امتحان کنید"}finally{s=[[{text:" بازگشت",callback_data:"settings"}]],sendMessage(a,t,s)}break;case"newPost":const d=e.message;s=[[{text:"🔙 بازگشت به منوی اصلی",callback_data:"start"}]];try{const r=uuidv4();if(await db.createPost(a,r),t='🌅 لطفا محل قرارگیری واترمارک را مشخص کنید:\nجهت رد کردن این قسمت گزینه "⭕️ واترمارک نزن" را انتخاب کنید',s=[[{text:"↖️",callback_data:"watermarkPosition/northwest_"+r},{text:"⬆️",callback_data:"watermarkPosition/north_"+r},{text:"↗️",callback_data:"watermarkPosition/northeast_"+r}],[{text:"⬅️",callback_data:"watermarkPosition/west_"+r},{text:"⏺️",callback_data:"watermarkPosition/center_"+r},{text:"➡️",callback_data:"watermarkPosition/east_"+r}],[{text:"↙️",callback_data:"watermarkPosition/southwest_"+r},{text:"⬇️",callback_data:"watermarkPosition/south_"+r},{text:"↘️",callback_data:"watermarkPosition/southeast_"+r}],[{text:"⭕️ واترمارک نزن",callback_data:"watermarkPosition/none_"+r}],[{text:"🔙 بازگشت به منوی اصلی",callback_data:"start"}]],d.video){const i=d.video.file_id,o=await e.telegram.getFileLink(i),n=await axios.get(o,{responseType:"arraybuffer"}),l=Buffer.from(n.data),c=`./media/${r}.mp4`,g=path.join(__dirname,c);await fs.promises.writeFile(g,l);let m={caption:"",media:r,filetype:"mp4",created:Date.now(),output:r};setTimer(g);let p=await signMessages(d.caption,a);if(!p.ok)break;m.caption=p.data;const b=path.join(__dirname,`./media/${r}.json`),w=JSON.stringify(m);await fs.promises.writeFile(b,w),setTimer(b);const f=await db.getConfig("isWatermark");if(!f.ok)break;if(!(1===f.data.value||"1"===f.data.value)){let t=await pq.process_queries(a,"watermarkPosition/none_"+r,e,m);sendMessage(a,t.messageText,t.inlineKeyboard);break}sendMessage(a,t,s,m)}else if(d.photo){const i=d.photo,o=i[i.length-1].file_id,n=await e.telegram.getFileLink(o),l=await axios.get(n,{responseType:"arraybuffer"}),c=Buffer.from(l.data),g=`./media/${r}.jpg`,m=path.join(__dirname,g);await fs.promises.writeFile(m,c);let p={caption:"",media:r,filetype:"jpg",created:Date.now(),output:r};setTimer(m);let b=await signMessages(d.caption,a);if(!b.ok)break;p.caption=b.data;const w=path.join(__dirname,`./media/${r}.json`),f=JSON.stringify(p);await fs.promises.writeFile(w,f),setTimer(w);const u=await db.getConfig("isWatermark");if(!u.ok)break;if(!(1===u.data.value||"1"===u.data.value)){let t=await pq.process_queries(a,"watermarkPosition/none",e,p);sendMessage(a,t.messageText,t.inlineKeyboard);break}sendMessage(a,t,s)}else if(d.text){let r=await signMessages(i,a);if(!r.ok)break;t=r.data,e.reply("⁉️آیا از ارسال پیام زیر در کانال مطمئن هستید؟"),s=[[{text:"✅ تایید و ارسال",callback_data:"confirmPost/text"}],[{text:"🔙 بازگشت به منوی اصلی",callback_data:"start_again"}]],sendMessage(a,t,s)}}catch(e){s=[[{text:"🔙 بازگشت به منوی اصلی",callback_data:"start"}]],log.log_handler("Error in handling new posts data: "+e,"ERROR"),t="❗️ مشکلی پیش آمد. لطفا مجددا امتحان کنید",sendMessage(a,t,s)}}}catch(e){log.log_handler("Error in reading user input:"+error,"ERROR")}r&&(localVariable[a].receiver="")})),bot.command("checkadmin",(async e=>{const a=e.text.replace("/checkadmin ","@");await authorization.checkAdminStatus(e,a)?e.reply("The bot is an admin in the channel."):e.reply("The bot is NOT an admin in the channel.")})),bot.launch().then(console.log("Bot started successfully!")).catch((e=>{console.error("Error starting the bot:",e)}));