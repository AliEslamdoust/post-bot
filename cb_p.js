// Copyright (c) 2025 Ali Eslamdoust
// MIT License

require("dotenv").config();const db=require("./db"),moment=require("jalali-moment"),fs=require("fs"),path=require("path"),wm=require("./m_wm"),authorization=require("./authorization"),{logger:logger}=require("./log");async function process_queries(a,e,t,r){const i=a.id;let s=i;const n=a.role;let l,c,o=new Array,d="",k=new Object;e.includes("/")&&(c=e.split("/")[1],e=e.split("/")[0]);try{switch(e){case"start":"writer"===n?o=[[{text:"âœï¸ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯",callback_data:"addNewPost"}],[{text:"âœ‰ï¸ Ù¾Ø³Øª Ù‡Ø§ÛŒ Ù…Ù†",callback_data:"myPosts"},{text:"ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ",callback_data:"profile"}]]:"owner"!==n&&"admin"!==n||(o=[[{text:"ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",callback_data:"manageUsers"},{text:"âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª",callback_data:"settings"}],[{text:"ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ",callback_data:"profile"}],[{text:"âœï¸ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯",callback_data:"addNewPost"},{text:"âœ‰ï¸ Ù¾Ø³Øª Ù‡Ø§ÛŒ Ù…Ù†",callback_data:"myPosts"}]]),l="ğŸ’  ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ\n\nğŸ”¶ Ø¬Ù‡Øª Ø§Ø¯Ø§Ù…Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:";break;case"manageUsers":if("owner"!=n&&"admin"!=n)break;o=[[{text:"â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯",callback_data:"addUser"}],[{text:"ğŸ‘¥ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",callback_data:"seeUsers"}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]],l="ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\nâ” Ù„Ø·ÙØ§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";break;case"addUser":if("owner"!=n&&"admin"!=n)break;l="ğŸ”° Ù„Ø·ÙØ§ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n\nâ•Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒØªÙˆØ§Ù†Ø¯ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ø§Ø² Ø±Ø¨Ø§Øª Ø²ÛŒØ± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯:\n@userinfobot\nØ§Ø² Ø¢Ù†Ù‡Ø§ Ø¨Ø®ÙˆØ§Ù‡ÛŒØ¯ ØªØ§ Ø¢ÛŒØ¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø±Ø¨Ø§Øª Ø¨Ø§Ù„Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø¨ÙØ±Ø³ØªÙ†Ø¯",o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"manageUsers"}]],d="getNewUserId";break;case"seeUsers":if("owner"!=n&&"admin"!=n)break;let a=c||1;l=`ğŸ‘¥ Ù„ÛŒØ³Øª ØªÙ…Ø§Ù…ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø¨Ø§Øª\n\nØµÙØ­Ù‡ ${a}\n\nâ‰ï¸ Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒ Ø¨ÛŒØ´ØªØ± Ù…ÛŒØªÙˆÙ†ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ø¨ÙØ±Ø³ØªÛŒØ¯ ØªØ§ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒØ´ÙˆÙ† Ø±Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒÙ†`;const e=await db.getAllUsers();if(!e.ok)break;const b=sortUsers(e.data);for(let e=20*(a-1);e<=20*a&&e<b.length;e++){let a=b[e].id,t=b[e].role;switch(t){case"owner":t="Ù…Ø§Ù„Ú©";break;case"admin":t="Ù…Ø¯ÛŒØ±";break;case"writer":t="Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡"}const r=[{text:`ğŸ‘¤ ${t} - ${a}`,callback_data:`seeUser/${a}`}];e%2==0?o.push(r):o[o.length-1].push(r[0])}const m=Math.ceil(b.length/20),f=[{text:"ğŸ”š ØµÙØ­Ù‡ Ø¢Ø®Ø±",callback_data:`seeUsers/${m}`}],p=[{text:"ğŸ” ØµÙØ­Ù‡ Ø§ÙˆÙ„",callback_data:"seeUsers/1"}],_={text:"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯",callback_data:`seeUsers/${a+1}`},g={text:"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„",callback_data:"seeUsers/"+(a-1)},u={text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"manageUsers"};1===a&&a!=m?(o.push(f),o.push([_,u])):a===m&&1!=a?(o.push(p),o.push([u,g])):1!=a&&a!=m?(o.push([f[0],p[0]]),o.push([_,u,g])):o.push([u]),d="findUserWithId";break;case"seeUser":if("owner"!=n&&"admin"!=n)break;let w=await db.getUser(c);if(!w.ok)break;let h=await db.getAllUsersPosts(c);if(!h.ok)break;w=w.data,h=sortPosts(h.data);let x=0,$=Date.now()-2592e3;h.forEach((a=>{a.date>$&&x++}));let U=h.data?timestampToJalaliDate(h[0].date):"Ù†Ø§Ù…Ø´Ø®Øµ";l=`ğŸ‘¤ Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ø±Ø¨Ø±: \n\nğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ:\n    \`${c}\`\nâ„¹ï¸ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:\n${w.name}\n\nğŸ“† ØªØ§Ø±ÛŒØ® Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø³Øª:\n${U}\n\n#ï¸âƒ£ ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø³Øª Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±: ${x}\n\nâ™¾ï¸ Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø³Øª Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±: ${h.length}`,o=[[{text:"ğŸ’  ØªØºÛŒÛŒØ± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±",callback_data:`changeUserRole/${c}`}],[{text:"ğŸ“† ÙØ¹Ø§Ù„ÛŒØª Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±",callback_data:`seeUserActivities/${c}`}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"seeUsers"}]],w.role!==n&&"owner"!==w.role||o.shift();break;case"changeUserRole":if("owner"!=n&&"admin"!=n)break;let y=await db.getUser(c);if(!y.ok)break;y=y.data.role,l=`ğŸ”± Ø¬Ù‡Øª ØªØºÛŒÛŒØ± Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯\n\nâ• Ø³Ø·Ø­ ÙØ¹Ù„ÛŒ: ${"admin"===y?"Ù…Ø¯ÛŒØ±":"Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡"}`,"owner"===n?"writer"===y?o=[[{text:"ğŸ”º Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù…Ø¯ÛŒØ±",callback_data:`promote/${c}`}],[{text:"ğŸš« Ø§Ø®Ø±Ø§Ø¬ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡",callback_data:`fire/${c}`}]]:"admin"===y&&(o=[[{text:"ğŸ”» ØªÙ†Ø²Ù„ Ù…Ù‚Ø§Ù… Ú©Ø§Ø±Ø¨Ø±",callback_data:`demote/${c}`}]]):"admin"===n&&"writer"===y&&(o=[[{text:"ğŸ”º Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù…Ø¯ÛŒØ±",callback_data:`promoteRequest/${c}`}],[{text:"ğŸš« Ø§Ø®Ø±Ø§Ø¬ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡",callback_data:`fire/${c}`}]]),o.push([{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`seeUser/${c}`}]);break;case"promote":if("owner"!=n)break;let P=await db.getUser(c);if(!P.ok)break;l=`â‰ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø§Ø±ØªÙ‚Ø§ "${P.data.name}" Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,o=[[{text:"âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±ØªÙ‚Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±",callback_data:`roleConfirm/promotion_${c}`}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`changeUserRole/${c}`}]];break;case"promoteRequest":if("admin"!=n)break;let v=await db.getUser(c);if(!v.ok)break;l=`â‰ï¸ Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ Ù‡Ø³ØªÛŒØ¯ Ø¨Ù‡ Ù…Ø§Ù„Ú© Ø±Ø¨Ø§Øª ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ "${v.data.name}" Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ\nØ¯Ø± ØµÙˆØ±Øª ØªØ§ÛŒÛŒØ¯ Ù…Ø§Ù„Ú© Ø±Ø¨Ø§ØªØŒ Ø´Ø®Øµ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø±ØªÙ‚Ø§ Ù…ÛŒ ÛŒØ§Ø¨Ø¯`,o=[[{text:"âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±ØªÙ‚Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±",callback_data:`roleConfirm/promotionR_${c}`}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`changeUserRole/${c}`}]];break;case"demote":if("owner"!=n&&"admin"!=n)break;let S=await db.getUser(c);if(!S.ok)break;l=`â‰ï¸ Ø¢ÛŒØ§ Ø§Ø² ØªÙ†Ø²Ù„ Ù…Ù‚Ø§Ù… "${S.data.name}" Ø¨Ù‡ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,o=[[{text:"âœ… ØªØ£ÛŒÛŒØ¯ ØªÙ†Ø²Ù„ Ù…Ù‚Ø§Ù… Ú©Ø§Ø±Ø¨Ø±",callback_data:`roleConfirm/demotion_${c}`}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`changeUserRole/${c}`}]];break;case"fire":if("owner"!=n&&"admin"!=n)break;let q=await db.getUser(c);if(!q.ok)break;l=`â‰ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø§Ø®Ø±Ø§Ø¬ "${q.data.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,o=[[{text:"âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø®Ø±Ø§Ø¬ Ú©Ø§Ø±Ø¨Ø±",callback_data:`roleConfirm/firing_${c}`}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`changeUserRole/${c}`}]];break;case"roleConfirm":if("owner"!=n&&"admin"!=n)break;let A=c.split("_")[1],C=c.split("_")[0];if(o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`seeUser/${A}`}]],"promotion"===C){if(!await db.updateUserRole(A,"admin"))break;l="âœ… Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØª"}else if("demotion"===C){if(!await db.updateUserRole(A,"writer"))break;l="âœ… ØªÙ†Ø²Ù„ Ù…Ù‚Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"}else if("firing"===C){if(!await db.deleteUser(A))break;o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"seeUsers"}]],t.reply('âœ… Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø®Ø±Ø§Ø¬ Ø´Ø¯\nØ¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ø² Ù‚Ø³Ù…Øª "ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† > â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯" Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯',{reply_markup:{inline_keyboard:o}}),s=A,l="â—ï¸ Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒØŒ Ø´Ù…Ø§ ØªÙˆØ³Ø· ÛŒÚ© Ù…Ø¯ÛŒØ± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯ÛŒØ¯",o=[]}else if("promotionR_"===C){if(!await db.deleteUser(A))break;const a=process.env.OWNER;t.reply("â” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±ØªÙ‚Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…Ø§Ù„Ú© Ø±Ø¨Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯",{reply_markup:{inline_keyboard:o}}),s=a,l='â” Ù…Ø¯ÛŒØ± "" Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±ØªÙ‚Ø§ÛŒ "" Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø§Ø±Ø¯\nØ¯Ø± ØµÙˆØ±Øª ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§ Ø§ÛŒÙ† Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø±ØªÙ‚Ø§ Ù…ÛŒ ÛŒØ§Ø¨Ø¯\nØ¢ÛŒØ§ Ù…ÙˆØ§ÙÙ‚ Ù‡Ø³ØªÛŒØ¯ØŸ',o=[[{text:"âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù…Ø¯ÛŒØ±",callback_data:`promote/${A}`}],[{text:"âŒ  Ø±Ø¯ Ú©Ø±Ø¯Ù† Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ",callback_data:"start"}]]}break;case"seeUserActivities":if("owner"!=n&&"admin"!=n)break;let D=c.split("_")[0],N=c.includes("_")?c.split("_")[1]:1,R=await db.getAllUsersPosts(D);if(!R.ok)break;if(0==R.data.length){l="â—ï¸ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‡ÛŒÚ† Ù¾Ø³ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª",o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`seeUser/${D}`}]];break}let j=sortPosts(R.data);for(let a=20*(N-1);a<=20*N&&a<j.length;a++){const e=[{text:`ğŸ“… ${timestampToJalaliDate(j[a].date)}`,callback_data:`seePost/${j[a].id}_${D}`}];a%2==0?o.push(e):o[o.length-1].push(e[0])}const T=Math.ceil(sortPosts.length/20),I=[{text:"ğŸ”š ØµÙØ­Ù‡ Ø¢Ø®Ø±",callback_data:`seeUserActivities/${D}_${T}`}],W=[{text:"ğŸ” ØµÙØ­Ù‡ Ø§ÙˆÙ„",callback_data:`seeUserActivities/${D}`}],E={text:"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯",callback_data:`seeUserActivities/${D}_${N+1}`},J={text:"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„",callback_data:`seeUserActivities/${D}_${N-1}`},M={text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`seeUser/${D}`};1===N&&N!=T?(o.push(I),o.push([E,M])):N===T&&1!=N?(o.push(W),o.push([M,J])):1!=N&&N!=T?(o.push([I[0],W[0]]),o.push([E,M,J])):o.push([M]),l=`ğŸ”† Ù¾Ø³Øª Ù‡Ø§ÛŒ \`${D}\` Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¯Ø± Ù„ÛŒØ³Øª Ø²ÛŒØ± Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ Ù…ÛŒØªÙˆØ§Ù†ÛŒØ¯ Ù„ÛŒØ³Øª Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ú©Ù†ÛŒØ¯\n\nâ•Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡ 20 Ù¾Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´ÙˆÙ†Ø¯\n\nØµÙØ­Ù‡ ${N}`;break;case"seePost":let Y=c.split("_")[1],H=c.split("_")[0];const z=await db.getPost(H);if(!z.ok)break;l=z.data.link,o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:`seeUserActivities/${Y}`}]];break;case"settings":if("owner"!=n&&"admin"!=n)break;o=[[{text:"ğŸ”¹ ØªØºÛŒÛŒØ± ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©",callback_data:"changeWtermark"},{text:"ğŸ”¸ ØªØºÛŒÛŒØ± Ø§Ù…Ø¶Ø§ÛŒ Ù…ØªÙ†ÛŒ",callback_data:"changeSignature"}],[{text:"ğŸ”° Ø§Ù…Ø¶Ø§ÛŒ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡",callback_data:"writersSign"}]],o.push([{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]),l="âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª:\n\nâ” Ù„Ø·ÙØ§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";break;case"changeWtermark":if("owner"!=n&&"admin"!=n)break;const O=await db.getConfig("isWatermark");if(!O.ok)break;let L=1===O.data.value||"1"===O.data.value;l="â‰ï¸ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø± ÙØ±Ù…Øª png Ø¨ÙØ±Ø³ØªÛŒØ¯:",o=[L?[{text:"â­•ï¸ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©",callback_data:"turnoff/isWatermark"}]:[{text:"âœ… Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©",callback_data:"turnon/isWatermark"}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"settings"}]],d="watermark";break;case"changeSignature":if("owner"!=n&&"admin"!=n)break;const V=await db.getConfig("signature");if(!V.ok)break;const F=await db.getConfig("isSign");if(!F.ok)break;l=`âœï¸ Ø§Ù…Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nâ• Ø§Ù…Ø¶Ø§ÛŒ ÙØ¹Ù„ÛŒ:\n${V.data.value}`,o=[1===F.data.value||"1"===F.data.value?[{text:"â­•ï¸ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§",callback_data:"turnoff/isSign"}]:[{text:"âœ… Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§",callback_data:"turnon/isSign"}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"settings"}]],d="newSign";break;case"turnoff":if("owner"!=n&&"admin"!=n)break;if(!await db.updateConfig(c,!1))break;l=`âœ… ${"isWatermark"==c?"ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©":"Ø§Ù…Ø¶Ø§"} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯`,o.push([{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"settings"}]);break;case"turnon":if("owner"!=n&&"admin"!=n)break;if(!await db.updateConfig(c,!0))break;l=`âœ… ${"isWatermark"==c?"ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©":"Ø§Ù…Ø¶Ø§"} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯`,o.push([{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"settings"}]);break;case"writersSign":if("owner"!=n&&"admin"!=n)break;const K=await db.getConfig("writerSign");if(!K.ok)break;l="â“ Ø§Ù…Ø¶Ø§ÛŒ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ Ù‡Ø§ ÙØ¹Ø§Ù„ Ø´ÙˆØ¯ØŸ\nØ§ÛŒÙ† Ø§Ù…Ø¶Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø²ÛŒØ± Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù…Ø¶Ø§ÛŒ Ù…ØªÙ†ÛŒ Ù‚Ø±Ø§Ø± Ù…ÛŒÚ¯ÛŒØ±Ø¯:\n\nğŸ–‹ Ù†Ø§Ù… Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡",o=[1===K.data.value||"1"===K.data.value?[{text:"â­•ï¸ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§",callback_data:"turnoff/writerSign"}]:[{text:"âœ… Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§",callback_data:"turnon/writerSign"}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"settings"}]];break;case"profile":if("owner"!=n&&"admin"!=n&&"writer"!=n)break;const B=await db.getUser(i);if(!B.ok)break;let G=B.data.role;"owner"===G?G="Ù…Ø§Ù„Ú© Ø±Ø¨Ø§Øª":"admin"===G?G="Ù…Ø¯ÛŒØ± Ø±Ø¨Ø§Øª":" writer"===G&&(G="Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡"),l=`ğŸ“± Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§\n\nğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø´Ù…Ø§: \`${B.data.id}\`\nâ„¹ï¸ Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø´Ù…Ø§: ${B.data.name}\n\nğŸ”± Ø±ØªØ¨Ù‡ Ø´Ù…Ø§: ${G}`,o=[[{text:"â™»ï¸ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø±",callback_data:"changeName"}],[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]];break;case"changeName":if("owner"!=n&&"admin"!=n&&"writer"!=n)break;l="â” Ù„Ø·ÙØ§ Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n\nğŸ”¸ ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 3 ØªØ§ 32 Ø­Ø±Ù Ø¨Ø§Ø´Ø¯\nğŸ”¹ Ø§ÛŒÙ† Ù†Ø§Ù… Ø¯Ø± Ù‡Ø± Ø²Ù…Ø§Ù† Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø§Ø³Øª",d="changeName";break;case"myPosts":if("owner"!=n&&"admin"!=n)break;let Q=c||1,X=await db.getAllUsersPosts(i);if(!X.ok)break;if(0==X.data.length){l="â—ï¸ Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù¾Ø³ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯",o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]];break}let Z=sortPosts(X.data);for(let a=20*(Q-1);a<=20*Q&&a<Z.length;a++){const e=[{text:`ğŸ“… ${timestampToJalaliDate(Z[a].date)}`,callback_data:`seeMyPost/${Z[a].id}`}];a%2==0?o.push(e):o[o.length-1].push(e[0])}const aa=Math.ceil(Z.length/20),ea=[{text:"ğŸ”š ØµÙØ­Ù‡ Ø¢Ø®Ø±",callback_data:`myPosts/${aa}`}],ta=[{text:"ğŸ” ØµÙØ­Ù‡ Ø§ÙˆÙ„",callback_data:"myPosts"}],ra={text:"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯",callback_data:`myPosts/${Q+1}`},ia={text:"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„",callback_data:"myPosts/"+(Q-1)},sa={text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"};1===Q&&Q!=aa?(o.push(ea),o.push([ra,sa])):Q===aa&&1!=Q?(o.push(ta),o.push([sa,ia])):1!=Q&&Q!=aa?(o.push([ea[0],ta[0]]),o.push([ra,sa,ia])):o.push([sa]);let na=0,la=Date.now()-2592e3;Z.forEach((a=>{a.date>la&&na++})),l=`ğŸ”† Ù¾Ø³Øª Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§Ø² Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ ØªØ±ÛŒÙ† Ø¯Ø± Ù„ÛŒØ³Øª Ø²ÛŒØ± Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ Ù…ÛŒØªÙˆØ§Ù†ÛŒØ¯ Ù„ÛŒØ³Øª Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ú©Ù†ÛŒØ¯\n\nâ•Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡ 20 Ù¾Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´ÙˆÙ†Ø¯\n\nØµÙØ­Ù‡ ${Q}\n\nâœ”ï¸  Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø³Øª :\nğŸ• ${timestampToJalaliDate(Z[0].date)}\nğŸ“† Ù¾Ø³Øª Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±: ${na}\nâ™¾ï¸ ØªÙ…Ø§Ù… Ù¾Ø³Øª Ù‡Ø§ÛŒ Ø´Ù…Ø§: ${Z.length}`;break;case"seeMyPost":let ca=c;const oa=await db.getPost(ca);if(!oa.ok)break;l=oa.data.link,o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"myPosts"}]];break;case"addNewPost":if("owner"!=n&&"admin"!=n&&"writer"!=n)break;l='ğŸ–‹ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯ Ù…ÛŒ Ø¨Ø§Ø´ÛŒØ¯\n  \n  â” ÛŒÚ© Ù¾Ø³Øª Ø´Ø§Ù…Ù„ Ú†Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒ Ù‡Ø§ÛŒÛŒ Ù…ÛŒØ¨Ø§Ø´Ø¯ØŸ\n  ğŸ“ Ù…ÛŒ ØªÙˆØ§Ù†Ø¯ Ø¯Ø§Ø±Ø§ÛŒ ÛŒÚ© Ø¹Ú©Ø³ ÛŒØ§ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§Ø´Ø¯\n  âœï¸ Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø¨Ø§ Ú©Ù¾Ø´Ù† Ù‡Ù…Ø±Ø§Ù‡ Ø§Ø³Øª\n  â• Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù†Ø§Ù… Ù…Ø³ØªØ¹Ø§Ø± Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…Ø·Ù„Ø¨ Ø¯Ø±Ø¬ Ø´ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ú¯Ø²ÛŒÙ†Ù‡ "ğŸ”° Ø§Ù…Ø¶Ø§ÛŒ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡" Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯\n  ğŸ“Œ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ù¾ÛŒØ§Ù… Ù‡Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø§Ø³Øª\n  \n  â—ï¸ ØªÙˆØ¬Ù‡: Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø§Ù…Ø¶Ø§ÛŒ Ù¾ÛŒØ§Ù… Ù‡Ø§ ÛŒØ§ Ú†Ø³Ø¨Ø§Ù†Ø¯Ù† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ø±ÙˆÛŒ Ø¹Ú©Ø³ Ùˆ ÙˆÛŒØ¯ÛŒÙˆ Ù‡Ø§ Ù†ÛŒØ³ØªØŒ Ø§ÛŒÙ† Ú©Ø§Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒØ´ÙˆØ¯',o.push([{text:"ğŸ”™ Ù„ØºÙˆ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]),d="newPost";break;case"watermarkPosition":let da,ka=c,ba=path.join(__dirname,`./media/${r.media}.${r.filetype}`),ma="jpg"===r.filetype?await wm.getImageDimensions(ba):await wm.getVideoDimensions(ba);if(!ma.ok)break;let fa,pa=await wm.calculateWatermarkPosition(ka,ma);if(!fs.existsSync(ba)){k={mediaType:void 0};break}if("none"===ka?(da=path.join(__dirname,`./media/${r.media}.${r.filetype}`),"jpg"===r.filetype?fa="image":"mp4"===r.filetype&&(fa="video")):("jpg"===r.filetype?(await wm.watermarkImage(r.media,pa,ka),fa="image"):"mp4"===r.filetype&&(await wm.watermarkVideo(r.media,pa),fa="video"),da=path.join(__dirname,`./media/output-${r.media}.${r.filetype}`),r.output="output-"+r.media),!fs.existsSync(da)){k={mediaYype:void 0};break}k={filePath:da,mediaType:fa,confirm:!1},t.reply("â‰ï¸Ø¢ÛŒØ§ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø²ÛŒØ± Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ"),l=r.caption,o=[[{text:"âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„",callback_data:"confirmPost_"+r.media}],[{text:"âŒ Ù„ØºÙˆ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start_again"}]],await fs.promises.writeFile(path.join(__dirname,`./media/${r.media}.json`),JSON.stringify(r));break;case"confirmPost":if(!await authorization.checkAdminStatus(t,process.env.CHANNEL_ID)){o=[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]],l="âŒ Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø±Ø¨Ø§Øª Ø±Ø§ Ù…Ø¯ÛŒØ± Ú©Ø§Ù†Ø§Ù„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ø¬Ø¯Ø¯Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯",k={mediaType:"placeholder",confirm:!1};break}const _a=path.join(__dirname,`./media/${r.output}.${r.filetype}`);if(!fs.existsSync(_a)){k={mediaType:void 0};break}let ga="jpg"===r.filetype?"image":"video";l=r.caption,s=process.env.CHANNEL_ID,k={message:{text:"âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯",keyborad:[[{text:"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª",callback_data:"start"}]],chatId:i},filePath:_a,mediaType:ga,confirm:!0,postId:r.media}}}catch(s){logger.error(`Error while processing ${e} query from ${i}: `+s,{user:a,query:e,ctx:t,customInfo:r})}finally{return{receiversId:s,messageText:l,inlineKeyboard:o,receiver:d,media:k}}}function sortUsers(a){const e={owner:3,admin:2,writer:1};return a.sort(((a,t)=>{const r=e[a.role]||0,i=e[t.role]||0;return r!==i?i-r:a.id-t.id}))}function sortPosts(a){return a.sort(((a,e)=>e.date-a.date))}function timestampToJalaliDate(a){try{const e=moment(a);return e.locale("fa").format("YYYY/MM/DD HH:mm:ss")}catch(a){return logger.error("Error in converting timestamp to a Jalali date: "+a),"Ù†Ø§Ù…Ø´Ø®Øµ"}}module.exports={process_queries:process_queries};